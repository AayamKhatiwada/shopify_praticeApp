import { buildHeaders, debugLogRequest, handlingErrors } from './common.js';
import { ScriptServiceProxyQuery } from './graphql/index.js';
import { partners as partnersFqdn } from '../environment/fqdn.js';
import { graphqlClient } from '../http/graphql.js';
import { ClientError, gql } from 'graphql-request';
export async function request(query, token, variables) {
    const api = 'Partners';
    return handlingErrors(api, async () => {
        const fqdn = await partnersFqdn();
        const url = `https://${fqdn}/api/cli/graphql`;
        const headers = await buildHeaders(token);
        debugLogRequest(api, query, variables, headers);
        const client = await graphqlClient({ headers, url });
        const response = await client.request(query, variables);
        return response;
    });
}
/**
 * Check if the given token is revoked and no longer valid to interact with the Partners API.
 * @param token - The token to check
 * @returns True if the token is revoked, false otherwise
 */
export async function checkIfTokenIsRevoked(token) {
    const query = gql `
    {
      organizations(first: 1) {
        nodes {
          id
        }
      }
    }
  `;
    const fqdn = await partnersFqdn();
    const url = `https://${fqdn}/api/cli/graphql`;
    const headers = await buildHeaders(token);
    const client = await graphqlClient({ headers, url });
    try {
        await client.request(query, {});
        return false;
        // eslint-disable-next-line no-catch-all/no-catch-all
    }
    catch (error) {
        if (error instanceof ClientError) {
            return error.response.status === 401;
        }
        return false;
    }
}
/**
 * Function queries are proxied through the script service proxy.
 * To execute a query, we encapsulate it inside another query (including the variables)
 * This is done automatically, you just need to provide the query and the variables.
 *
 * @param apiKey - APIKey of the app where the query will be executed.
 * @param query - GraphQL query to execute.
 * @param token - Partners token
 * @param variables - GraphQL variables to pass to the query.
 * @returns The response of the query.
 */
export async function functionProxyRequest(apiKey, query, token, variables) {
    const proxyVariables = {
        api_key: apiKey,
        query,
        variables: JSON.stringify(variables) || '{}',
    };
    const proxyQuery = ScriptServiceProxyQuery;
    const res = await request(proxyQuery, token, proxyVariables);
    const json = JSON.parse(res.scriptServiceProxy);
    return json;
}
//# sourceMappingURL=partners.js.map