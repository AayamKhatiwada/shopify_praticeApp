import { fetch } from './http.js';
import { debug, content, token } from './output.js';
const url = 'https://monorail-edge.shopifysvc.com/v1/produce';
// This is the topic name of the main event we log to Monorail, the command tracker
export const MONORAIL_COMMAND_TOPIC = 'app_cli3_command/1.2';
export async function publishEvent(schemaId, publicData, sensitiveData) {
    try {
        const currentTime = new Date().getTime();
        const payload = { ...publicData, ...sensitiveData };
        const body = JSON.stringify({ schema_id: schemaId, payload });
        const headers = buildHeaders(currentTime);
        const response = await fetch(url, { method: 'POST', body, headers });
        if (response.status === 200) {
            debug(content `Analytics event sent: ${token.json(payload)}`);
            return { type: 'ok' };
        }
        else {
            debug(`Failed to report usage analytics: ${response.statusText}`);
            return { type: 'error', message: response.statusText };
        }
        // eslint-disable-next-line no-catch-all/no-catch-all
    }
    catch (error) {
        let message = 'Failed to report usage analytics';
        if (error instanceof Error) {
            message = message.concat(`: ${error.message}`);
        }
        debug(message);
        return { type: 'error', message };
    }
}
const buildHeaders = (currentTime) => {
    return {
        'Content-Type': 'application/json; charset=utf-8',
        'X-Monorail-Edge-Event-Created-At-Ms': currentTime.toString(),
        'X-Monorail-Edge-Event-Sent-At-Ms': currentTime.toString(),
    };
};
//# sourceMappingURL=monorail.js.map