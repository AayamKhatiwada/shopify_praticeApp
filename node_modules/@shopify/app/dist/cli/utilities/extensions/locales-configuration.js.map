{"version":3,"file":"locales-configuration.js","sourceRoot":"","sources":["../../../../src/cli/utilities/extensions/locales-configuration.ts"],"names":[],"mappings":"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","sourcesContent":["import {ExternalExtensionTypes} from '../../constants.js'\nimport {error, path} from '@shopify/cli-kit'\nimport fs from 'fs'\n\nconst L10N_FILE_SIZE_LIMIT = 16 * 1024\nconst L10N_BUNDLE_SIZE_LIMIT = 256 * 1024\nconst CHECKOUT_UI_EXTENSION_KEY: ExternalExtensionTypes = 'checkout_ui'\n\nconst MissingDefaultLanguageError = () => {\n  return new error.Abort(\n    `Missing default language in ${CHECKOUT_UI_EXTENSION_KEY} configuration`,\n    'Make sure to have a {locale}.default.json file in your locales directory',\n  )\n}\n\nconst BigBundleError = () => {\n  return new error.Abort(\n    `Error loading ${CHECKOUT_UI_EXTENSION_KEY}`,\n    `Total size of all locale files must be less than ${L10N_BUNDLE_SIZE_LIMIT}`,\n  )\n}\n\nconst BigFileError = (filename: string) => {\n  return new error.Abort(\n    `Error loading ${CHECKOUT_UI_EXTENSION_KEY}`,\n    `Locale file ${filename} size must be less than ${L10N_FILE_SIZE_LIMIT}`,\n  )\n}\n\nconst EmptyFileError = (filename: string) => {\n  return new error.Abort(`Error loading ${CHECKOUT_UI_EXTENSION_KEY}`, `Locale file ${filename} can't be empty`)\n}\n\nconst MultipleDefaultError = () => {\n  return new error.Abort(\n    `Error loading ${CHECKOUT_UI_EXTENSION_KEY}`,\n    `There must be one (and only one) locale identified as the default locale: e.g. \"en.default.json\"`,\n  )\n}\n\nexport async function loadLocalesConfig(extensionPath: string) {\n  const localesPaths = await path.glob(path.join(extensionPath, 'locales/*.json'))\n  if (localesPaths.length === 0) return {}\n\n  // Bundle validations\n  const totalBundleSize = bundleSize(localesPaths)\n  const defaultLanguageCode = findDefaultLocale(localesPaths)\n  if (defaultLanguageCode.length === 0) throw MissingDefaultLanguageError()\n  if (defaultLanguageCode.length > 1) throw MultipleDefaultError()\n  if (totalBundleSize > L10N_BUNDLE_SIZE_LIMIT) throw BigBundleError()\n\n  // Locale validations\n  for (const locale of localesPaths) {\n    const size = fs.statSync(locale).size\n    if (size > L10N_FILE_SIZE_LIMIT) throw BigFileError(locale)\n    if (size === 0) throw EmptyFileError(locale)\n  }\n\n  return {\n    default_locale: defaultLanguageCode[0],\n    translations: getAllLocales(localesPaths),\n  }\n}\n\nfunction findDefaultLocale(filePaths: string[]) {\n  const defaultLocale = filePaths.filter((locale) => path.basename(locale).endsWith('.default.json'))\n  return defaultLocale.map((locale) => path.basename(locale).split('.')[0])\n}\n\nfunction getAllLocales(localesPath: string[]) {\n  const all: {[key: string]: string} = {}\n  for (const localePath of localesPath) {\n    const localeCode = path.basename(localePath).split('.')[0]!\n    const locale = fs.readFileSync(localePath, 'base64')\n    all[localeCode] = locale\n  }\n  return all\n}\n\nfunction bundleSize(localesPaths: string[]) {\n  return localesPaths.map((locale) => fs.statSync(locale).size).reduce((acc, size) => acc + size, 0)\n}\n"]}