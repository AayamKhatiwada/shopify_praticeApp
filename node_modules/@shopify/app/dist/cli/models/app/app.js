import { getUIExtensionRendererDependency } from '../../constants.js';
import { path, schema, file } from '@shopify/cli-kit';
import { getDependencies, readAndParsePackageJson } from '@shopify/cli-kit/node/node-package-manager';
export const AppConfigurationSchema = schema.define.object({
    scopes: schema.define.string().default(''),
    extensionDirectories: schema.define.array(schema.define.string()).optional(),
});
export var WebType;
(function (WebType) {
    WebType["Frontend"] = "frontend";
    WebType["Backend"] = "backend";
})(WebType || (WebType = {}));
export const WebConfigurationSchema = schema.define.object({
    type: schema.define.enum([WebType.Frontend, WebType.Backend]),
    auth_callback_path: schema.define
        .preprocess((arg) => (typeof arg === 'string' && !arg.startsWith('/') ? `/${arg}` : arg), schema.define.string())
        .optional(),
    commands: schema.define.object({
        build: schema.define.string().optional(),
        dev: schema.define.string(),
    }),
});
export class App {
    // eslint-disable-next-line max-params
    constructor(name, idEnvironmentVariableName, directory, packageManager, configuration, configurationPath, nodeDependencies, webs, ui, theme, functions, usesWorkspaces, dotenv, errors) {
        this.name = name;
        this.idEnvironmentVariableName = idEnvironmentVariableName;
        this.directory = directory;
        this.packageManager = packageManager;
        this.configuration = configuration;
        this.configurationPath = configurationPath;
        this.nodeDependencies = nodeDependencies;
        this.webs = webs;
        this.dotenv = dotenv;
        this.extensions = {
            ui,
            theme,
            function: functions,
        };
        this.errors = errors;
        this.usesWorkspaces = usesWorkspaces;
    }
    async updateDependencies() {
        const nodeDependencies = await getDependencies(path.join(this.directory, 'package.json'));
        this.nodeDependencies = nodeDependencies;
    }
    hasExtensions() {
        return (this.extensions.ui.length !== 0 || this.extensions.function.length !== 0 || this.extensions.theme.length !== 0);
    }
    hasUIExtensions() {
        return this.extensions.ui.length > 0;
    }
}
/**
 * Given a UI extension and the app it belongs to, it returns the version of the renderer package.
 * Looks for `/node_modules/@shopify/{renderer-package-name}/package.json` to find the real version used.
 * @param uiExtensionType - UI extension whose renderer version will be obtained.
 * @param app - App object containing the extension.
 * @returns The version if the dependency exists.
 */
export async function getUIExtensionRendererVersion(uiExtensionType, app) {
    // Look for the vanilla JS version of the dependency (the react one depends on it, will always be present)
    const rendererDependency = getUIExtensionRendererDependency(uiExtensionType);
    if (!rendererDependency)
        return undefined;
    return getDependencyVersion(rendererDependency.name, app.directory);
}
export async function getDependencyVersion(dependency, directory) {
    const isReact = dependency.includes('-react');
    let cwd = directory;
    /**
     * PNPM creates a symlink to a global cache where dependencies are hoisted. Therefore
     * we need to first look up the *-react package and use that as a working directory from
     * where to look up the non-react package.
     */
    if (isReact) {
        const dependencyName = dependency.split('/');
        const pattern = path.join('node_modules', dependencyName[0], dependencyName[1], 'package.json');
        const reactPackageJsonPath = await path.findUp(pattern, {
            type: 'file',
            cwd: directory,
            allowSymlinks: true,
        });
        if (!reactPackageJsonPath) {
            return 'not_found';
        }
        cwd = await file.realpath(path.dirname(reactPackageJsonPath));
    }
    // Split the dependency name to avoid using "/" in windows
    const dependencyName = dependency.replace('-react', '').split('/');
    const pattern = path.join('node_modules', dependencyName[0], dependencyName[1], 'package.json');
    let packagePath = await path.findUp(pattern, {
        cwd,
        type: 'file',
        allowSymlinks: true,
    });
    if (!packagePath)
        return 'not_found';
    packagePath = await file.realpath(packagePath);
    // Load the package.json and extract the version
    const packageContent = await readAndParsePackageJson(packagePath);
    if (!packageContent.version)
        return 'not_found';
    return { name: dependency, version: packageContent.version };
}
//# sourceMappingURL=app.js.map