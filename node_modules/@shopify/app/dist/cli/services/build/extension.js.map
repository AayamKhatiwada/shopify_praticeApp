{"version":3,"file":"extension.js","sourceRoot":"","sources":["../../../../src/cli/services/build/extension.ts"],"names":[],"mappings":"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","sourcesContent":["import {AppInterface} from '../../models/app/app.js'\nimport {UIExtension, FunctionExtension, ThemeExtension} from '../../models/app/extensions.js'\nimport {bundleExtension} from '../extensions/bundle.js'\nimport {error, system, abort, output} from '@shopify/cli-kit'\nimport {execThemeCheckCLI} from '@shopify/cli-kit/node/ruby'\nimport {Writable} from 'node:stream'\n\nexport interface ExtensionBuildOptions {\n  /**\n   * Standard output stream to send the output through.\n   */\n  stdout: Writable\n  /**\n   * Standard error stream to send the error output through.\n   */\n  stderr: Writable\n\n  /**\n   * Signal to abort the build process.\n   */\n  signal: abort.Signal\n\n  /**\n   * Overrides the default build directory.\n   */\n  buildDirectory?: string\n\n  /**\n   * The app that contains the extensions.\n   */\n  app: AppInterface\n}\n\nexport interface ThemeExtensionBuildOptions extends ExtensionBuildOptions {\n  /**\n   * The UI extensions to be built.\n   */\n  extensions: ThemeExtension[]\n}\n\n/**\n * It builds the theme extensions.\n * @param options - Build options.\n */\nexport async function buildThemeExtensions(options: ThemeExtensionBuildOptions): Promise<void> {\n  if (options.extensions.length === 0) return\n  options.stdout.write(`Running theme check on your Theme app extension...`)\n  const themeDirectories = options.extensions.map((extension) => extension.directory)\n  await execThemeCheckCLI({\n    directories: themeDirectories,\n    args: ['-C', ':theme_app_extension'],\n    stdout: options.stdout,\n    stderr: options.stderr,\n  })\n}\n\ninterface BuildUIExtensionsOptions {\n  app: AppInterface\n}\n\nexport async function buildUIExtensions(options: BuildUIExtensionsOptions): Promise<output.OutputProcess[]> {\n  if (options.app.extensions.ui.length === 0) {\n    return []\n  }\n\n  return options.app.extensions.ui.map((uiExtension) => {\n    return {\n      prefix: uiExtension.localIdentifier,\n      action: async (stdout: Writable, stderr: Writable, signal: abort.Signal) => {\n        await buildUIExtension(uiExtension, {stdout, stderr, signal, app: options.app})\n      },\n    }\n  })\n}\n\n/**\n * It builds the UI extensions.\n * @param options - Build options.\n */\nexport async function buildUIExtension(extension: UIExtension, options: ExtensionBuildOptions): Promise<void> {\n  options.stdout.write(`Bundling UI extension ${extension.localIdentifier}...`)\n\n  await bundleExtension({\n    minify: true,\n    outputBundlePath: extension.outputBundlePath,\n    sourceFilePath: extension.entrySourceFilePath,\n    environment: 'production',\n    env: options.app.dotenv?.variables ?? {},\n    stderr: options.stderr,\n    stdout: options.stdout,\n  })\n\n  options.stdout.write(`${extension.localIdentifier} successfully built`)\n}\n\nexport interface BuildFunctionExtensionOptions extends ExtensionBuildOptions {}\n\n/**\n * Builds a function extension\n * @param extension - The function extension to build.\n * @param options - Options to configure the build of the extension.\n */\nexport async function buildFunctionExtension(\n  extension: FunctionExtension,\n  options: BuildFunctionExtensionOptions,\n): Promise<void> {\n  const buildCommand = extension.configuration.build?.command\n  if (!buildCommand || buildCommand.trim() === '') {\n    options.stderr.write(\n      `The function extension ${extension.localIdentifier} doesn't have a build command or it's empty`,\n    )\n    options.stderr.write(`\n    Edit the shopify.function.extension.toml configuration file and set how to build the extension.\n\n    [build]\n    command = \"{COMMAND}\"\n\n    Note that the command must output a dist/index.wasm file.\n    `)\n    throw new error.AbortSilent()\n  }\n  const buildCommandComponents = buildCommand.split(' ')\n  options.stdout.write(`Building function ${extension.localIdentifier}...`)\n  await system.exec(buildCommandComponents[0]!, buildCommandComponents.slice(1), {\n    stdout: options.stdout,\n    stderr: options.stderr,\n    cwd: extension.directory,\n    signal: options.signal,\n  })\n}\n"]}