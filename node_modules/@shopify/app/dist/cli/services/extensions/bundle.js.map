{"version":3,"file":"bundle.js","sourceRoot":"","sources":["../../../../src/cli/services/extensions/bundle.ts"],"names":[],"mappings":"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","sourcesContent":["import {abort, path} from '@shopify/cli-kit'\nimport {build as esBuild, BuildFailure, BuildResult, formatMessagesSync} from 'esbuild'\nimport {Writable} from 'node:stream'\n\ninterface BundleOptions {\n  minify: boolean\n  env: {[variable: string]: string}\n  outputBundlePath: string\n  sourceFilePath: string\n  stdout: Writable\n  stderr: Writable\n\n  /**\n   * When provided, the bundling process keeps running and notifying about changes.\n   * When ESBuild detects changes in any of the modules of the graph it re-bundles it\n   * and calls this watch function.\n   */\n  watch?: (error: BuildFailure | null, result: BuildResult | null) => void\n\n  /**\n   * This signal allows the caller to stop the watching process.\n   */\n  watchSignal?: abort.Signal\n\n  /**\n   * Context:\n   * When the bundling extension lived in the Go binary, we tied the environment\n   * to the workflow being executed (i.e. development when running dev and production\n   * when running build) and expoed it through environment variables globally defined\n   * by ESBuild. This is a pattern we want to move away from because commands and\n   * environments are two different things. However, to do so we need to come up\n   * with a migration plan.\n   */\n  environment: 'development' | 'production'\n}\n\n/**\n * Invokes ESBuild with the given options to bundle an extension.\n * @param options - ESBuild options\n */\nexport async function bundleExtension(options: BundleOptions) {\n  const esbuildOptions = getESBuildOptions(options)\n  const result = await esBuild(esbuildOptions)\n  if (options.watchSignal) {\n    options.watchSignal.addEventListener('abort', () => {\n      if (result.stop) {\n        result.stop()\n      }\n    })\n  }\n  onResult(result, options)\n}\n\nfunction onResult(result: Awaited<ReturnType<typeof esBuild>> | null, options: BundleOptions) {\n  const warnings = result?.warnings ?? []\n  const errors = result?.errors ?? []\n  if (warnings.length > 0) {\n    const formattedWarnings = formatMessagesSync(warnings, {kind: 'warning'})\n    formattedWarnings.forEach((warning) => {\n      options.stdout.write(warning)\n    })\n  }\n  if (errors.length > 0) {\n    const formattedErrors = formatMessagesSync(errors, {kind: 'error'})\n    formattedErrors.forEach((error) => {\n      options.stderr.write(error)\n    })\n  }\n}\n\nfunction getESBuildOptions(options: BundleOptions): Parameters<typeof esBuild>[0] {\n  const env: {[variable: string]: string} = options.env\n  const define = Object.keys(env || {}).reduce(\n    (acc, key) => ({\n      ...acc,\n      [`process.env.${key}`]: JSON.stringify(env[key]),\n    }),\n    {'process.env.NODE_ENV': JSON.stringify(options.environment)},\n  )\n  let esbuildOptions: Parameters<typeof esBuild>[0] = {\n    entryPoints: [options.sourceFilePath],\n    outfile: options.outputBundlePath,\n    sourceRoot: path.dirname(options.sourceFilePath),\n    bundle: true,\n    define,\n    jsx: 'automatic',\n    loader: {\n      '.esnext': 'ts',\n      '.js': 'jsx',\n    },\n    legalComments: 'none',\n    minify: options.minify,\n    plugins: getPlugins(),\n    target: 'es6',\n    resolveExtensions: ['.tsx', '.ts', '.js', '.json', '.esnext', '.mjs', '.ejs'],\n  }\n  if (options.watch) {\n    const watch = options.watch\n    esbuildOptions = {\n      ...esbuildOptions,\n      watch: {\n        onRebuild: (error, result) => {\n          onResult(result, options)\n          watch(error, result)\n        },\n      },\n    }\n  }\n  return esbuildOptions\n}\n\ntype ESBuildPlugins = Parameters<typeof esBuild>[0]['plugins']\n\n/**\n * It returns the plugins that should be used with ESBuild.\n * @returns List of plugins.\n */\nfunction getPlugins(): ESBuildPlugins {\n  const plugins = []\n\n  if (isGraphqlPackageAvailable()) {\n    const {default: graphqlLoader} = require('@luckycatfactory/esbuild-graphql-loader')\n    plugins.push(graphqlLoader())\n  }\n\n  return plugins\n}\n\n/**\n * Returns true if the \"graphql\" and \"graphql-tag\" packages can be\n * resolved. This information is used to determine whether we should\n * or not include the esbuild-graphql-loader plugin when invoking ESBuild\n * @returns Returns true if the \"graphql\" and \"graphql-tag\" can be resolved.\n */\nfunction isGraphqlPackageAvailable(): boolean {\n  try {\n    // eslint-disable-next-line @babel/no-unused-expressions\n    require.resolve('graphql') && require.resolve('graphql-tag')\n    return true\n    // eslint-disable-next-line no-catch-all/no-catch-all\n  } catch {\n    return false\n  }\n}\n"]}