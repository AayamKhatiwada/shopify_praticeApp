{"version":3,"file":"dev.js","sourceRoot":"","sources":["../../../src/cli/services/dev.ts"],"names":[],"mappings":"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","sourcesContent":["import {ensureDevEnvironment} from './environment.js'\nimport {generateFrontendURL, generatePartnersURLs, getURLs, shouldOrPromptUpdateURLs, updateURLs} from './dev/urls.js'\nimport {installAppDependencies} from './dependencies.js'\nimport {devUIExtensions} from './dev/extension.js'\nimport {outputAppURL, outputExtensionsMessages, outputUpdateURLsResult} from './dev/output.js'\nimport {themeExtensionArgs} from './dev/theme-extension-args.js'\nimport {\n  ReverseHTTPProxyTarget,\n  runConcurrentHTTPProcessesAndPathForwardTraffic,\n} from '../utilities/app/http-reverse-proxy.js'\nimport {AppInterface, AppConfiguration, Web, WebType} from '../models/app/app.js'\nimport metadata from '../metadata.js'\nimport {UIExtension} from '../models/app/extensions.js'\nimport {fetchProductVariant} from '../utilities/extensions/fetch-product-variant.js'\nimport {analytics, output, port, system, session, abort, string, environment} from '@shopify/cli-kit'\nimport {Config} from '@oclif/core'\nimport {execCLI2} from '@shopify/cli-kit/node/ruby'\nimport {renderConcurrent} from '@shopify/cli-kit/node/ui'\nimport {Writable} from 'node:stream'\n\nexport interface DevOptions {\n  app: AppInterface\n  apiKey?: string\n  storeFqdn?: string\n  reset: boolean\n  update: boolean\n  commandConfig: Config\n  skipDependenciesInstallation: boolean\n  subscriptionProductUrl?: string\n  checkoutCartUrl?: string\n  tunnelUrl?: string\n  tunnel: boolean\n  noTunnel: boolean\n  theme?: string\n  themeExtensionPort?: number\n}\n\ninterface DevWebOptions {\n  backendPort: number\n  apiKey: string\n  apiSecret?: string\n  hostname?: string\n  scopes?: AppConfiguration['scopes']\n}\n\nasync function dev(options: DevOptions) {\n  const skipDependenciesInstallation = options.skipDependenciesInstallation\n  if (!skipDependenciesInstallation) {\n    // eslint-disable-next-line no-param-reassign\n    options = {\n      ...options,\n      app: await installAppDependencies(options.app),\n    }\n  }\n  const token = await session.ensureAuthenticatedPartners()\n  const {\n    identifiers,\n    storeFqdn,\n    app,\n    updateURLs: cachedUpdateURLs,\n    tunnelPlugin,\n  } = await ensureDevEnvironment(options, token)\n  const apiKey = identifiers.app\n\n  const {frontendUrl, frontendPort, usingLocalhost} = await generateFrontendURL({\n    ...options,\n    cachedTunnelPlugin: tunnelPlugin,\n  })\n\n  const backendPort = await port.getRandomPort()\n\n  const frontendConfig = options.app.webs.find(({configuration}) => configuration.type === WebType.Frontend)\n  const backendConfig = options.app.webs.find(({configuration}) => configuration.type === WebType.Backend)\n\n  /** If the app doesn't have web/ the link message is not necessary */\n  const exposedUrl = usingLocalhost ? `${frontendUrl}:${frontendPort}` : frontendUrl\n  let shouldUpdateURLs = false\n  if ((frontendConfig || backendConfig) && options.update) {\n    const currentURLs = await getURLs(apiKey, token)\n    const newURLs = generatePartnersURLs(exposedUrl, backendConfig?.configuration.auth_callback_path)\n    shouldUpdateURLs = await shouldOrPromptUpdateURLs({\n      currentURLs,\n      appDirectory: options.app.directory,\n      cachedUpdateURLs,\n      newApp: app.newApp,\n    })\n    if (shouldUpdateURLs) await updateURLs(newURLs, apiKey, token)\n    await outputUpdateURLsResult(shouldUpdateURLs, newURLs, app)\n    outputAppURL(storeFqdn, exposedUrl)\n  }\n\n  // If we have a real UUID for an extension, use that instead of a random one\n  options.app.extensions.ui.forEach((ext) => (ext.devUUID = identifiers.extensions[ext.localIdentifier] ?? ext.devUUID))\n\n  const backendOptions = {\n    apiKey,\n    backendPort,\n    scopes: options.app.configuration.scopes,\n    apiSecret: (app.apiSecret as string) ?? '',\n    hostname: exposedUrl,\n  }\n\n  const proxyTargets: ReverseHTTPProxyTarget[] = []\n  const proxyPort = usingLocalhost ? await port.getRandomPort() : frontendPort\n  const proxyUrl = usingLocalhost ? `${frontendUrl}:${proxyPort}` : frontendUrl\n\n  if (options.app.extensions.ui.length > 0) {\n    const devExt = await devUIExtensionsTarget({\n      app: options.app,\n      apiKey,\n      url: proxyUrl,\n      storeFqdn,\n      grantedScopes: app.grantedScopes,\n      subscriptionProductUrl: options.subscriptionProductUrl,\n      checkoutCartUrl: options.checkoutCartUrl,\n    })\n    proxyTargets.push(devExt)\n  }\n\n  outputExtensionsMessages(options.app, storeFqdn, proxyUrl)\n\n  const additionalProcesses: output.OutputProcess[] = []\n\n  if (options.app.extensions.theme.length > 0) {\n    const adminSession = await session.ensureAuthenticatedAdmin(storeFqdn)\n    const storefrontToken = await session.ensureAuthenticatedStorefront()\n    const extension = options.app.extensions.theme[0]!\n    const args = await themeExtensionArgs(extension, apiKey, token, options)\n    const devExt = await devThemeExtensionTarget(args, adminSession, storefrontToken, token)\n    additionalProcesses.push(devExt)\n  }\n\n  if (backendConfig) {\n    additionalProcesses.push(await devBackendTarget(backendConfig, backendOptions))\n  }\n\n  if (frontendConfig) {\n    const frontendOptions: DevFrontendTargetOptions = {\n      web: frontendConfig,\n      apiKey,\n      scopes: options.app.configuration.scopes,\n      apiSecret: (app.apiSecret as string) ?? '',\n      hostname: frontendUrl,\n      backendPort,\n    }\n\n    if (usingLocalhost) {\n      additionalProcesses.push(devFrontendNonProxyTarget(frontendOptions, frontendPort))\n    } else {\n      proxyTargets.push(devFrontendProxyTarget(frontendOptions))\n    }\n  }\n\n  await logMetadataForDev({devOptions: options, tunnelUrl: frontendUrl, shouldUpdateURLs, storeFqdn})\n\n  await analytics.reportEvent({config: options.commandConfig})\n\n  if (proxyTargets.length === 0) {\n    await renderConcurrent({processes: additionalProcesses})\n  } else {\n    await runConcurrentHTTPProcessesAndPathForwardTraffic(proxyPort, proxyTargets, additionalProcesses)\n  }\n}\n\ninterface DevFrontendTargetOptions extends DevWebOptions {\n  web: Web\n  backendPort: number\n}\n\nfunction devFrontendNonProxyTarget(options: DevFrontendTargetOptions, port: number): output.OutputProcess {\n  const devFrontend = devFrontendProxyTarget(options)\n  return {\n    prefix: devFrontend.logPrefix,\n    action: async (stdout: Writable, stderr: Writable, signal: abort.Signal) => {\n      await devFrontend.action(stdout, stderr, signal, port)\n    },\n  }\n}\n\nfunction devThemeExtensionTarget(\n  args: string[],\n  adminSession: session.AdminSession,\n  storefrontToken: string,\n  token: string,\n): output.OutputProcess {\n  return {\n    prefix: 'extensions',\n    action: async (_stdout: Writable, _stderr: Writable, _signal: abort.Signal) => {\n      await execCLI2(['extension', 'serve', ...args], {adminSession, storefrontToken, token})\n    },\n  }\n}\n\nfunction devFrontendProxyTarget(options: DevFrontendTargetOptions): ReverseHTTPProxyTarget {\n  const {commands} = options.web.configuration\n  const [cmd, ...args] = commands.dev.split(' ')\n  const env = {\n    SHOPIFY_API_KEY: options.apiKey,\n    SHOPIFY_API_SECRET: options.apiSecret,\n    HOST: options.hostname,\n    SCOPES: options.scopes,\n    BACKEND_PORT: `${options.backendPort}`,\n    NODE_ENV: `development`,\n  }\n\n  return {\n    logPrefix: options.web.configuration.type,\n    action: async (stdout: Writable, stderr: Writable, signal: abort.Signal, port: number) => {\n      await system.exec(cmd!, args, {\n        cwd: options.web.directory,\n        stdout,\n        stderr,\n        env: {\n          ...process.env,\n          ...env,\n          PORT: `${port}`,\n          FRONTEND_PORT: `${port}`,\n          APP_URL: options.hostname,\n          APP_ENV: 'development',\n          // Note: These are Laravel varaibles for backwards compatibility with 2.0 templates.\n          SERVER_PORT: `${port}`,\n        },\n        signal,\n      })\n    },\n  }\n}\n\nasync function devBackendTarget(web: Web, options: DevWebOptions): Promise<output.OutputProcess> {\n  const {commands} = web.configuration\n  const [cmd, ...args] = commands.dev.split(' ')\n  const env = {\n    SHOPIFY_API_KEY: options.apiKey,\n    SHOPIFY_API_SECRET: options.apiSecret,\n    HOST: options.hostname,\n    // SERVER_PORT is the convention Artisan uses\n    PORT: `${options.backendPort}`,\n    SERVER_PORT: `${options.backendPort}`,\n    BACKEND_PORT: `${options.backendPort}`,\n    SCOPES: options.scopes,\n    NODE_ENV: `development`,\n    ...(environment.service.isSpinEnvironment() && {\n      SHOP_CUSTOM_DOMAIN: `shopify.${await environment.spin.fqdn()}`,\n    }),\n  }\n\n  return {\n    prefix: web.configuration.type,\n    action: async (stdout: Writable, stderr: Writable, signal: abort.Signal) => {\n      await system.exec(cmd!, args, {\n        cwd: web.directory,\n        stdout,\n        stderr,\n        signal,\n        env: {\n          ...process.env,\n          ...env,\n        },\n      })\n    },\n  }\n}\n\ninterface DevUIExtensionsTargetOptions {\n  app: AppInterface\n  apiKey: string\n  url: string\n  storeFqdn: string\n  grantedScopes: string[]\n  subscriptionProductUrl?: string\n  checkoutCartUrl?: string\n}\n\nasync function devUIExtensionsTarget({\n  app,\n  apiKey,\n  url,\n  storeFqdn,\n  grantedScopes,\n  subscriptionProductUrl,\n  checkoutCartUrl,\n}: DevUIExtensionsTargetOptions): Promise<ReverseHTTPProxyTarget> {\n  const cartUrl = await buildCartURLIfNeeded(app.extensions.ui, storeFqdn, checkoutCartUrl)\n  return {\n    logPrefix: 'extensions',\n    pathPrefix: '/extensions',\n    action: async (stdout: Writable, stderr: Writable, signal: abort.Signal, port: number) => {\n      await devUIExtensions({\n        app,\n        extensions: app.extensions.ui,\n        stdout,\n        stderr,\n        signal,\n        url,\n        port,\n        storeFqdn,\n        apiKey,\n        grantedScopes,\n        checkoutCartUrl: cartUrl,\n        subscriptionProductUrl,\n      })\n    },\n  }\n}\n\n/**\n * To prepare Checkout UI Extensions for dev'ing we need to retrieve a valid product variant ID\n * @param extensions - The UI Extensions to dev\n * @param store - The store FQDN\n */\nasync function buildCartURLIfNeeded(extensions: UIExtension[], store: string, checkoutCartUrl?: string) {\n  const hasUIExtension = extensions.map((ext) => ext.type).includes('checkout_ui_extension')\n  if (!hasUIExtension) return undefined\n  if (checkoutCartUrl) return checkoutCartUrl\n  const variantId = await fetchProductVariant(store)\n  return `/cart/${variantId}:1`\n}\n\nasync function logMetadataForDev(options: {\n  devOptions: DevOptions\n  tunnelUrl: string\n  shouldUpdateURLs: boolean\n  storeFqdn: string\n}) {\n  const tunnelType = await analytics.getAnalyticsTunnelType(options.devOptions.commandConfig, options.tunnelUrl)\n  await metadata.addPublic(() => ({\n    cmd_dev_tunnel_type: tunnelType,\n    cmd_dev_tunnel_custom_hash: tunnelType === 'custom' ? string.hashString(options.tunnelUrl) : undefined,\n    cmd_dev_urls_updated: options.shouldUpdateURLs,\n    store_fqdn_hash: string.hashString(options.storeFqdn),\n    cmd_app_dependency_installation_skipped: options.devOptions.skipDependenciesInstallation,\n    cmd_app_reset_used: options.devOptions.reset,\n  }))\n\n  await metadata.addSensitive(() => ({\n    store_fqdn: options.storeFqdn,\n    cmd_dev_tunnel_custom: tunnelType === 'custom' ? options.tunnelUrl : undefined,\n  }))\n}\n\nexport default dev\n"]}