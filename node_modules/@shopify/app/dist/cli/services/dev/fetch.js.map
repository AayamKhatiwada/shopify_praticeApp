{"version":3,"file":"fetch.js","sourceRoot":"","sources":["../../../../src/cli/services/dev/fetch.ts"],"names":[],"mappings":"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","sourcesContent":["import {Organization, OrganizationApp, OrganizationStore} from '../../models/organization.js'\nimport {api, error, output} from '@shopify/cli-kit'\n\nexport const NoOrgError = (organizationId?: string) => {\n  const nextSteps = [\n    output.content`Have you ${output.token.link(\n      'created a Shopify Partners organization',\n      'https://partners.shopify.com/signup',\n    )}?`,\n    output.content`Have you confirmed your accounts from the emails you received?`,\n    output.content`Need to connect to a different App or organization? Run the command again with ${output.token.genericShellCommand(\n      '--reset',\n    )}`,\n  ]\n  if (organizationId) {\n    nextSteps.push(\n      output.content`Do you have access to the right Shopify Partners organization? The CLI is loading ${output.token.link(\n        'this organization',\n        `https://partner.shopify.com/${organizationId}`,\n      )}`,\n    )\n  }\n  return new error.Abort(\n    `No Organization found`,\n    nextSteps.map((content) => `Â· ${output.stringifyMessage(content)}`).join('\\n'),\n  )\n}\n\nexport interface FetchResponse {\n  organization: Organization\n  apps: OrganizationApp[]\n  stores: OrganizationStore[]\n}\n\nexport async function fetchAppExtensionRegistrations({\n  token,\n  apiKey,\n}: {\n  token: string\n  apiKey: string\n}): Promise<api.graphql.AllAppExtensionRegistrationsQuerySchema> {\n  const query = api.graphql.AllAppExtensionRegistrationsQuery\n  const result: api.graphql.AllAppExtensionRegistrationsQuerySchema = await api.partners.request(query, token, {\n    apiKey,\n  })\n  return result\n}\n\n/**\n * Fetch all organizations the user belongs to\n * If the user doesn't belong to any org, throw an error\n * @param token - Token to access partners API\n * @returns List of organizations\n */\nexport async function fetchOrganizations(token: string) {\n  const query = api.graphql.AllOrganizationsQuery\n  const result: api.graphql.AllOrganizationsQuerySchema = await api.partners.request(query, token)\n  const organizations = result.organizations.nodes\n  if (organizations.length === 0) throw NoOrgError()\n  return organizations\n}\n\n/**\n * Fetch all apps and stores for the given organization\n * @param orgId - Organization ID\n * @param token - Token to access partners API\n * @returns Current organization details and list of apps and stores\n */\nexport async function fetchOrgAndApps(orgId: string, token: string): Promise<FetchResponse> {\n  const query = api.graphql.FindOrganizationQuery\n  const result: api.graphql.FindOrganizationQuerySchema = await api.partners.request(query, token, {id: orgId})\n  const org = result.organizations.nodes[0]\n  if (!org) throw NoOrgError(orgId)\n  const parsedOrg = {id: org.id, businessName: org.businessName, appsNext: org.appsNext}\n  return {organization: parsedOrg, apps: org.apps.nodes, stores: []}\n}\n\nexport async function fetchAppFromApiKey(apiKey: string, token: string): Promise<OrganizationApp | undefined> {\n  const res: api.graphql.FindAppQuerySchema = await api.partners.request(api.graphql.FindAppQuery, token, {apiKey})\n  return res.app\n}\n\nexport async function fetchOrgFromId(id: string, token: string): Promise<Organization | undefined> {\n  const query = api.graphql.FindOrganizationBasicQuery\n  const res: api.graphql.FindOrganizationBasicQuerySchema = await api.partners.request(query, token, {id})\n  return res.organizations.nodes[0]\n}\n\nexport async function fetchAllStores(orgId: string, token: string): Promise<OrganizationStore[]> {\n  const query = api.graphql.AllStoresByOrganizationQuery\n  const result: api.graphql.AllStoresByOrganizationSchema = await api.partners.request(query, token, {id: orgId})\n  return result.organizations.nodes[0]!.stores.nodes\n}\n\ninterface FetchStoreByDomainOutput {\n  organization: Organization\n  store?: OrganizationStore\n}\n/**\n * Returns the organization and the store based on passed domain\n * If a store with that domain doesn't exist the method returns undefined\n * @param orgId - Organization ID\n * @param token - Token to access partners API\n * @param shopDomain - shop domain fqdn\n */\nexport async function fetchStoreByDomain(\n  orgId: string,\n  token: string,\n  shopDomain: string,\n): Promise<FetchStoreByDomainOutput | undefined> {\n  const query = api.graphql.FindStoreByDomainQuery\n  const result: api.graphql.FindStoreByDomainSchema = await api.partners.request(query, token, {\n    id: orgId,\n    shopDomain,\n  })\n  const org = result.organizations.nodes[0]\n  if (!org) {\n    return undefined\n  }\n\n  const parsedOrg = {id: org.id, businessName: org.businessName, appsNext: org.appsNext}\n  const store = org.stores.nodes[0]\n\n  return {organization: parsedOrg, store}\n}\n"]}