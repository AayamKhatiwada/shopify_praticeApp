{"version":3,"file":"middlewares.js","sourceRoot":"","sources":["../../../../../../src/cli/services/dev/extension/server/middlewares.ts"],"names":[],"mappings":"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","sourcesContent":["import {getExtensionUrl, getRedirectUrl, sendError} from './utilities.js'\nimport {GetExtensionsMiddlewareOptions} from './models.js'\nimport {getUIExtensionPayload} from '../payload.js'\nimport {getUIExtensionSurface} from '../../../../utilities/extensions/configuration.js'\nimport {getHTML} from '../templates.js'\nimport {file, http, output, path} from '@shopify/cli-kit'\n\nexport function corsMiddleware(\n  request: http.IncomingMessage,\n  response: http.ServerResponse,\n  next: (err?: Error) => unknown,\n) {\n  response.setHeader('Access-Control-Allow-Origin', '*')\n  response.setHeader('Access-Control-Allow-Methods', 'GET, OPTIONS')\n  response.setHeader(\n    'Access-Control-Allow-Headers',\n    'Accept, Content-Type, Content-Length, Accept-Encoding, X-CSRF-Token, Authorization, ngrok-skip-browser-warning',\n  )\n  next()\n}\n\nexport function noCacheMiddleware(\n  request: http.IncomingMessage,\n  response: http.ServerResponse,\n  next: (err?: Error) => unknown,\n) {\n  response.setHeader('Cache-Control', 'no-cache')\n  next()\n}\n\nexport async function redirectToDevConsoleMiddleware(\n  request: http.IncomingMessage,\n  response: http.ServerResponse,\n  next: (err?: Error) => unknown,\n) {\n  await http.sendRedirect(response.event, '/extensions/dev-console', 307)\n}\n\nexport async function fileServerMiddleware(\n  request: http.IncomingMessage,\n  response: http.ServerResponse,\n  next: (err?: Error) => unknown,\n  options: {filePath: string},\n) {\n  let {filePath} = options\n\n  if (await file.isDirectory(filePath)) {\n    filePath += filePath.endsWith('/') ? `index.html` : '/index.html'\n  }\n\n  const fileExists = await file.exists(filePath)\n\n  if (!fileExists) {\n    return sendError(response, {statusCode: 404, statusMessage: `Not Found: ${filePath}`})\n  }\n\n  const fileContent = await file.read(filePath)\n  const extensionToContent = {\n    '.ico': 'image/x-icon',\n    '.html': 'text/html',\n    '.js': 'text/javascript',\n    '.json': 'application/json',\n    '.css': 'text/css',\n    '.png': 'image/png',\n    '.jpg': 'image/jpeg',\n    '.wav': 'audio/wav',\n    '.mp3': 'audio/mpeg',\n    '.svg': 'image/svg+xml',\n    '.pdf': 'application/pdf',\n    '.doc': 'application/msword',\n  } as const\n\n  const extensionName = path.extname(filePath) as keyof typeof extensionToContent\n  const contentType = extensionToContent[extensionName] || 'text/plain'\n\n  response.setHeader('Content-Type', contentType)\n  response.writeHead(200)\n  response.end(fileContent)\n}\n\nexport function getExtensionAssetMiddleware({devOptions}: GetExtensionsMiddlewareOptions) {\n  return async (request: http.IncomingMessage, response: http.ServerResponse, next: (err?: Error) => unknown) => {\n    const {extensionId, assetPath} = request.context.params\n    const extension = devOptions.extensions.find((extension) => extension.devUUID === extensionId)\n\n    if (!extension) {\n      return sendError(response, {\n        statusCode: 404,\n        statusMessage: `Extension with id ${extensionId} not found`,\n      })\n    }\n\n    const buildDirectory = extension.outputBundlePath.replace('main.js', '')\n\n    return fileServerMiddleware(request, response, next, {\n      filePath: path.join(buildDirectory, assetPath),\n    })\n  }\n}\n\nexport function getExtensionsPayloadMiddleware({payloadStore}: GetExtensionsMiddlewareOptions) {\n  return async (request: http.IncomingMessage, response: http.ServerResponse, next: (err?: Error) => unknown) => {\n    response.setHeader('content-type', 'application/json')\n    response.end(JSON.stringify(payloadStore.getRawPayload()))\n  }\n}\n\nexport async function devConsoleIndexMiddleware(\n  request: http.IncomingMessage,\n  response: http.ServerResponse,\n  next: (err?: Error) => unknown,\n) {\n  const rootDirectory = await path.findUp(path.join('assets', 'dev-console'), {\n    type: 'directory',\n    cwd: path.moduleDirectory(import.meta.url),\n  })\n\n  if (!rootDirectory) {\n    return sendError(response, {\n      statusCode: 404,\n      statusMessage: `Could not find root directory for dev console`,\n    })\n  }\n\n  return fileServerMiddleware(request, response, next, {\n    filePath: rootDirectory,\n  })\n}\n\nexport async function devConsoleAssetsMiddleware(\n  request: http.IncomingMessage,\n  response: http.ServerResponse,\n  next: (err?: Error) => unknown,\n) {\n  const {assetPath} = request.context.params\n\n  const rootDirectory = await path.findUp(path.join('assets', 'dev-console', 'extensions', 'dev-console', 'assets'), {\n    type: 'directory',\n    cwd: path.moduleDirectory(import.meta.url),\n  })\n\n  if (!rootDirectory) {\n    return sendError(response, {\n      statusCode: 404,\n      statusMessage: `Could not find root directory for dev console asset`,\n    })\n  }\n\n  return fileServerMiddleware(request, response, next, {\n    filePath: path.join(rootDirectory, assetPath),\n  })\n}\n\nexport function getLogMiddleware({devOptions}: GetExtensionsMiddlewareOptions) {\n  return async (request: http.IncomingMessage, response: http.ServerResponse, next: (err?: Error) => unknown) => {\n    output.debug(`UI extensions server received a ${request.method} request to URL ${request.url}`, (message) =>\n      devOptions.stdout.write(message, 'utf8'),\n    )\n    next()\n  }\n}\n\nexport function getExtensionPayloadMiddleware({devOptions}: GetExtensionsMiddlewareOptions) {\n  return async (request: http.IncomingMessage, response: http.ServerResponse, next: (err?: Error) => unknown) => {\n    const extensionID = request.context.params.extensionId\n    const extension = devOptions.extensions.find((extension) => extension.devUUID === extensionID)\n\n    if (!extension) {\n      return sendError(response, {\n        statusCode: 404,\n        statusMessage: `Extension with id ${extensionID} not found`,\n      })\n    }\n\n    if (request.headers.accept?.startsWith('text/html')) {\n      const extensionSurface = getUIExtensionSurface(extension.configuration.type)\n\n      if (extensionSurface === 'post_purchase') {\n        const body = await getHTML({\n          data: {\n            url: getExtensionUrl(extension, devOptions),\n          },\n          template: 'index',\n          extensionSurface,\n        })\n        await http.send(response.event, body)\n        return\n      } else {\n        const url = getRedirectUrl(extension, devOptions)\n        await http.sendRedirect(response.event, url, 307)\n        return\n      }\n    }\n\n    response.setHeader('content-type', 'application/json')\n    response.end(\n      JSON.stringify({\n        app: {\n          apiKey: devOptions.apiKey,\n        },\n        version: '3',\n        root: {\n          url: new URL('/extensions', devOptions.url).toString(),\n        },\n        socket: {\n          url: getWebsocketUrl(devOptions),\n        },\n        devConsole: {\n          url: new URL('/extensions/dev-console', devOptions.url).toString(),\n        },\n        store: devOptions.storeFqdn,\n        extension: await getUIExtensionPayload(extension, devOptions),\n      }),\n    )\n  }\n}\n\nfunction getWebsocketUrl(devOptions: GetExtensionsMiddlewareOptions['devOptions']) {\n  const socket = new URL('/extensions', devOptions.url)\n  socket.protocol = 'wss:'\n\n  return socket.toString()\n}\n"]}