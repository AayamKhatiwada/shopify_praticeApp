{"version":3,"file":"select-store.js","sourceRoot":"","sources":["../../../../src/cli/services/dev/select-store.ts"],"names":[],"mappings":"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","sourcesContent":["import {fetchAllStores, fetchStoreByDomain} from './fetch.js'\nimport {Organization, OrganizationStore} from '../../models/organization.js'\nimport {reloadStoreListPrompt, selectStorePrompt} from '../../prompts/dev.js'\nimport {error, output, api, system, ui, environment} from '@shopify/cli-kit'\n\nconst ConvertToDevError = (storeName: string, message: string) => {\n  return new error.Bug(\n    `Error converting store ${storeName} to a Test store: ${message}`,\n    'This store might not be compatible with draft apps, please try a different store',\n  )\n}\n\nconst InvalidStore = (storeName: string) => {\n  return new error.Abort(\n    `The store you specified (${storeName}) is not a dev store`,\n    'Run dev --reset and select an eligible dev store.',\n  )\n}\n\nconst CreateStoreLink = async (orgId: string) => {\n  const url = `https://${await environment.fqdn.partners()}/${orgId}/stores/new?store_type=dev_store`\n  return (\n    `Looks like you don't have a dev store in the Partners org you selected. ` +\n    `Keep going â€” create a dev store on Shopify Partners:\\n${url}\\n`\n  )\n}\n\n/**\n * Select store from list or\n * If a cachedStoreName is provided, we check if it is valid and return it. If it's not valid, ignore it.\n * If there are no stores, show a link to create a store and prompt the user to refresh the store list\n * If no store is finally selected, exit process\n * @param stores - List of available stores\n * @param orgId - Current organization ID\n * @param cachedStoreName - Cached store name\n * @returns The selected store\n */\nexport async function selectStore(\n  stores: OrganizationStore[],\n  org: Organization,\n  token: string,\n  cachedStoreName?: string,\n): Promise<OrganizationStore> {\n  if (cachedStoreName) {\n    const result = await fetchStoreByDomain(org.id, token, cachedStoreName)\n    if (result?.store) {\n      await convertToTestStoreIfNeeded(result.store, org, token)\n      return result.store\n    }\n  }\n\n  const store = await selectStorePrompt(stores)\n  if (store) {\n    await convertToTestStoreIfNeeded(store, org, token)\n    return store\n  }\n\n  output.info(`\\n${await CreateStoreLink(org.id)}`)\n  await system.sleep(5)\n\n  const reload = await reloadStoreListPrompt(org)\n  if (!reload) {\n    throw new error.CancelExecution()\n  }\n\n  const data = await waitForCreatedStore(org.id, token)\n  return selectStore(data, org, token)\n}\n\n/**\n * Retrieves the list of stores from an organization, retrying a few times if the list is empty.\n * That is because after creating the dev store, it can take some seconds for the API to return it.\n * @param orgId - Current organization ID\n * @param token - Token to access partners API\n * @returns List of stores\n */\nasync function waitForCreatedStore(orgId: string, token: string): Promise<OrganizationStore[]> {\n  const retries = 10\n  const secondsToWait = 3\n  let data = [] as OrganizationStore[]\n  const list = ui.newListr(\n    [\n      {\n        title: 'Fetching organization data',\n        task: async () => {\n          for (let i = 0; i < retries; i++) {\n            // eslint-disable-next-line no-await-in-loop\n            const stores = await fetchAllStores(orgId, token)\n            if (stores.length > 0) {\n              data = stores\n              return\n            }\n            // eslint-disable-next-line no-await-in-loop\n            await system.sleep(secondsToWait)\n          }\n        },\n      },\n    ],\n    {rendererSilent: environment.local.isUnitTest()},\n  )\n  await list.run()\n\n  return data\n}\n\n/**\n * Check if the store exists in the current organization and it is a valid store\n * To be valid, it must be non-transferable.\n * @param storeDomain - Store domain to check\n * @param stores - List of available stores\n * @param orgId - Current organization ID\n * @param token - Token to access partners API\n * @returns True if the store is valid\n * @throws If the store can't be found in the organization or we fail to make it a test store\n */\nexport async function convertToTestStoreIfNeeded(\n  store: OrganizationStore,\n  org: Organization,\n  token: string,\n): Promise<void> {\n  /**\n   * Is not possible to convert stores to dev ones in spin environmets. Should be created directly as development.\n   */\n  if (environment.service.isSpinEnvironment() && environment.local.firstPartyDev()) return\n  if (!store.transferDisabled && !store.convertableToPartnerTest) throw InvalidStore(store.shopDomain)\n  if (!store.transferDisabled) await convertStoreToTest(store, org.id, token)\n}\n\n/**\n * Convert a store to a test store so development apps can be installed\n * This can't be undone, so we ask the user to confirm\n * @param store - Store to convert\n * @param orgId - Current organization ID\n * @param token - Token to access partners API\n */\nexport async function convertStoreToTest(store: OrganizationStore, orgId: string, token: string) {\n  const query = api.graphql.ConvertDevToTestStoreQuery\n  const variables: api.graphql.ConvertDevToTestStoreVariables = {\n    input: {\n      organizationID: parseInt(orgId, 10),\n      shopId: store.shopId,\n    },\n  }\n  const result: api.graphql.ConvertDevToTestStoreSchema = await api.partners.request(query, token, variables)\n  if (!result.convertDevToTestStore.convertedToTestStore) {\n    const errors = result.convertDevToTestStore.userErrors.map((error) => error.message).join(', ')\n    throw ConvertToDevError(store.shopDomain, errors)\n  }\n  output.success(`Converted ${store.shopDomain} to a Test store`)\n}\n"]}