{"version":3,"file":"extension.js","sourceRoot":"","sources":["../../../../src/cli/services/dev/extension.ts"],"names":[],"mappings":"AAAA,OAAO,EAAC,yBAAyB,EAAC,MAAM,0BAA0B,CAAA;AAClE,OAAO,EAAC,wBAAwB,EAAC,MAAM,0BAA0B,CAAA;AACjE,OAAO,EAAC,0BAA0B,EAAC,MAAM,wBAAwB,CAAA;AACjE,OAAO,EAAC,eAAe,EAAC,MAAM,uBAAuB,CAAA;AACrD,OAAO,EAAC,sBAAsB,EAAE,mCAAmC,EAAC,MAAM,8BAA8B,CAAA;AAGxG,OAAO,EAAC,MAAM,EAAQ,MAAM,kBAAkB,CAAA;AAwE9C,MAAM,CAAC,KAAK,UAAU,eAAe,CAAC,OAA4B;IAChE,MAAM,UAAU,GAAwB;QACtC,GAAG,OAAO;QACV,eAAe,EAAE,MAAM,yBAAyB,CAAC,OAAO,CAAC,UAAU,EAAE,OAAO,CAAC,SAAS,EAAE,OAAO,CAAC,eAAe,CAAC;KACjH,CAAA;IAED,MAAM,mBAAmB,GAAG;QAC1B,GAAG,UAAU;QACb,YAAY,EAAE,eAAe,CAAC,OAAO,CAAC,GAAG,CAAC;KAC3C,CAAA;IACD,MAAM,sBAAsB,GAAG,MAAM,mCAAmC,CAAC,mBAAmB,CAAC,CAAA;IAC7F,MAAM,YAAY,GAAG,IAAI,sBAAsB,CAAC,sBAAsB,EAAE,mBAAmB,CAAC,CAAA;IAE5F,MAAM,CAAC,KAAK,CAAC,6CAA6C,CAAC,CAAA;IAC3D,MAAM,UAAU,GAAG,eAAe,CAAC,EAAC,UAAU,EAAE,YAAY,EAAC,CAAC,CAAA;IAE9D,MAAM,CAAC,KAAK,CAAC,kDAAkD,CAAC,CAAA;IAChE,MAAM,mBAAmB,GAAG,wBAAwB,CAAC;QACnD,UAAU;QACV,YAAY;KACb,CAAC,CAAA;IACF,MAAM,CAAC,KAAK,CAAC,2DAA2D,CAAC,CAAA;IACzE,MAAM,WAAW,GAAG,MAAM,0BAA0B,CAAC,EAAC,UAAU,EAAE,YAAY,EAAC,CAAC,CAAA;IAEhF,OAAO,CAAC,MAAM,CAAC,gBAAgB,CAAC,OAAO,EAAE,GAAG,EAAE;QAC5C,WAAW,CAAC,KAAK,EAAE,CAAA;QACnB,mBAAmB,CAAC,KAAK,EAAE,CAAA;QAC3B,UAAU,CAAC,KAAK,EAAE,CAAA;IACpB,CAAC,CAAC,CAAA;AACJ,CAAC;AAED,SAAS,eAAe,CAAC,GAA+B;IACtD,MAAM,YAAY,GAAG,IAAI,GAAG,CAAC,aAAa,EAAE,GAAG,CAAC,CAAA;IAChD,YAAY,CAAC,QAAQ,GAAG,MAAM,CAAA;IAE9B,OAAO,YAAY,CAAC,QAAQ,EAAE,CAAA;AAChC,CAAC","sourcesContent":["import {getCartPathFromExtensions} from './extension/utilities.js'\nimport {setupWebsocketConnection} from './extension/websocket.js'\nimport {setupBundlerAndFileWatcher} from './extension/bundler.js'\nimport {setupHTTPServer} from './extension/server.js'\nimport {ExtensionsPayloadStore, getExtensionsPayloadStoreRawPayload} from './extension/payload/store.js'\nimport {AppInterface} from '../../models/app/app.js'\nimport {UIExtension} from '../../models/app/extensions.js'\nimport {output, abort} from '@shopify/cli-kit'\nimport {Writable} from 'node:stream'\n\nexport interface ExtensionDevOptions {\n  /**\n   * Standard output stream to send the output through.\n   */\n  stdout: Writable\n  /**\n   * Standard error stream to send the error output through.\n   */\n  stderr: Writable\n\n  /**\n   * Signal to abort the build process.\n   */\n  signal: abort.Signal\n\n  /**\n   * Overrides the default build directory.\n   */\n  buildDirectory?: string\n\n  /**\n   * The extension to be built.\n   */\n  extensions: UIExtension[]\n\n  /**\n   * The app that contains the extension.\n   */\n  app: AppInterface\n\n  /**\n   * The app identifier\n   */\n  apiKey: string\n\n  /**\n   * URL where the extension is locally served from. It's usually the tunnel URL\n   */\n  url: string\n\n  /**\n   * The port where the extension is hosted.\n   * It's usually the tunnel port\n   */\n  port: number\n\n  /**\n   * The development store where the extension wants to be previewed\n   */\n  storeFqdn: string\n\n  /**\n   * List of granted approval scopes belonging to the parent app\n   */\n  grantedScopes: string[]\n\n  /**\n   * Product variant ID, used for checkout_ui_extensions\n   * If that extension is present, this is mandatory\n   */\n  checkoutCartUrl?: string\n\n  /**\n   * Subscription product URL, used for subscription_ui_extensions\n   * If not provided the first product in the store will be used\n   */\n  subscriptionProductUrl?: string\n}\n\nexport async function devUIExtensions(options: ExtensionDevOptions): Promise<void> {\n  const devOptions: ExtensionDevOptions = {\n    ...options,\n    checkoutCartUrl: await getCartPathFromExtensions(options.extensions, options.storeFqdn, options.checkoutCartUrl),\n  }\n\n  const payloadStoreOptions = {\n    ...devOptions,\n    websocketURL: getWebSocketUrl(options.url),\n  }\n  const payloadStoreRawPayload = await getExtensionsPayloadStoreRawPayload(payloadStoreOptions)\n  const payloadStore = new ExtensionsPayloadStore(payloadStoreRawPayload, payloadStoreOptions)\n\n  output.debug(`Setting up the UI extensions HTTP server...`)\n  const httpServer = setupHTTPServer({devOptions, payloadStore})\n\n  output.debug(`Setting up the UI extensions Websocket server...`)\n  const websocketConnection = setupWebsocketConnection({\n    httpServer,\n    payloadStore,\n  })\n  output.debug(`Setting up the UI extensions bundler and file watching...`)\n  const fileWatcher = await setupBundlerAndFileWatcher({devOptions, payloadStore})\n\n  options.signal.addEventListener('abort', () => {\n    fileWatcher.close()\n    websocketConnection.close()\n    httpServer.close()\n  })\n}\n\nfunction getWebSocketUrl(url: ExtensionDevOptions['url']) {\n  const websocketURL = new URL('/extensions', url)\n  websocketURL.protocol = 'wss:'\n\n  return websocketURL.toString()\n}\n"]}